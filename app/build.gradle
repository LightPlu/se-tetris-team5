/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/9.0.0/userguide/building_java_projects.html in the Gradle documentation.
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    id 'jacoco'
    id 'distribution'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // This dependency is used by the application.
    implementation libs.guava

    // Annotation processor configuration to resolve build issues
    annotationProcessor libs.guava
    
    // MP3 playback support (JavaSound SPI + JLayer)
    implementation 'com.googlecode.soundlibs:mp3spi:1.9.5-1'
    implementation 'com.googlecode.soundlibs:tritonus-share:0.3.7-3'
    implementation 'com.googlecode.soundlibs:jlayer:1.0.1-1'
}

testing {
    suites {
        // Configure the built-in test suite
        test {
            // Use JUnit4 test framework
            useJUnit('4.13.2')
        }
    }
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

application {
    // Define the main class for the application.
    mainClass = 'se.tetris.team5.App'
}

/* âœ… íŒ€ ì „ì²´ UTF-8 ì¸ì½”ë”© ê°•ì œ ì„¤ì • (ìš´ì˜ì²´ì œ ë¬´ê´€) */
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

tasks.withType(JavaExec) {
    jvmArgs "-Dfile.encoding=UTF-8"
}

tasks.withType(Test) {
    systemProperty "file.encoding", "UTF-8"
    finalizedBy jacocoTestReport
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = false
        csv.required = false
        html.outputLocation = layout.buildDirectory.dir('jacocoHtml')  
    }
}

// Fat JAR ìƒì„± - ëª¨ë“  ì˜ì¡´ì„±ì„ í¬í•¨í•œ ë…ë¦½ ì‹¤í–‰ ê°€ëŠ¥í•œ JAR
task fatJar(type: Jar) {
    archiveClassifier = 'fat'
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    // ë©”ì¸ í´ë˜ìŠ¤ ì§€ì • ë° UTF-8 ì¸ì½”ë”© ì„¤ì •
    manifest {
        attributes(
            'Main-Class': 'se.tetris.team5.App',
            'Implementation-Title': 'Chainsaw Tetris Game',
            'Implementation-Version': project.version,
            'Created-By': 'Team 5'
        )
    }
    
    // í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì»´íŒŒì¼ëœ í´ë˜ìŠ¤ í¬í•¨
    from sourceSets.main.output
    
    // ëª¨ë“  ëŸ°íƒ€ì„ ì˜ì¡´ì„±ì„ JARì— í¬í•¨
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
}

// ë„¤ì´í‹°ë¸Œ EXE ìƒì„±
task createNativeExe {
    dependsOn fatJar
    group = 'distribution'
    description = 'ë„¤ì´í‹°ë¸Œ Windows EXE íŒŒì¼ ìƒì„± (JPackage ì‚¬ìš©)'
    
    doLast {
        // ê¸°ì¡´ ë„¤ì´í‹°ë¸Œ EXE ì‚­ì œ
        def nativeDir = new File(project.buildDir, "native-exe/ChainSaw-Tetris")
        if (nativeDir.exists()) {
            nativeDir.deleteDir()
        }
        
        try {
            // JPackageë¡œ ë„¤ì´í‹°ë¸Œ EXE ìƒì„±
            def jpackageCmd = [
                'jpackage',
                '--input', "${project.buildDir}/libs",
                '--name', 'ChainSaw-Tetris',
                '--main-jar', "${project.name}-fat.jar",
                '--main-class', 'se.tetris.team5.App',
                '--type', 'app-image',
                '--dest', "${project.buildDir}/native-exe",
                '--app-version', '1.0',
                '--description', 'ChainSaw Tetris Game - Team 5',
                '--vendor', 'Team 5',
                '--icon', "${project.projectDir}/src/main/resources/Tetris_icon.ico"
            ]
            
            def process = new ProcessBuilder(jpackageCmd)
                .directory(project.projectDir)
                .start()
            
            process.waitFor()
            
            if (process.exitValue() == 0) {
                println "âœ… ë„¤ì´í‹°ë¸Œ EXE íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
                println "ğŸ“‚ ìœ„ì¹˜: ${project.buildDir}/native-exe/ChainSaw-Tetris/"
                println "ğŸ® ì‹¤í–‰: ChainSaw-Tetris.exe ë”ë¸”í´ë¦­"
                println "ï¿½ ì•„ì´ì½˜: Tetris_icon.ico ì ìš©ë¨"
            } else {
                throw new Exception("JPackage ì‹¤í–‰ ì‹¤íŒ¨")
            }
            
        } catch (Exception e) {
            println "âŒ ë„¤ì´í‹°ë¸Œ EXE ìƒì„± ì‹¤íŒ¨: ${e.message}"
            println "ğŸ’¡ Java 14+ ë²„ì „ê³¼ JPackageê°€ í•„ìš”í•©ë‹ˆë‹¤."
        }
    }
}

// EXE ë°°í¬ìš© ZIP íŒ¨í‚¤ì§€ ìƒì„±
task createExeZip(type: Zip) {
    dependsOn createNativeExe
    group = 'distribution'
    description = 'ë„¤ì´í‹°ë¸Œ EXE ë°°í¬ìš© ZIP íŒŒì¼ ìƒì„±'
    
    archiveFileName = 'ChainSaw-Tetris-Native-v1.0.zip'
    destinationDirectory = file("$buildDir/distributions")
    
    from "$buildDir/native-exe/ChainSaw-Tetris"
    
    doLast {
        println "âœ… ë„¤ì´í‹°ë¸Œ EXE ë°°í¬ìš© ZIPì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:"
        println "ğŸ“¦ íŒŒì¼: $buildDir/distributions/$archiveFileName"
    }
}

// ìµœì¢… ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
task packageForDistribution {
    dependsOn createExeZip
    group = 'distribution'
    description = 'ë„¤ì´í‹°ë¸Œ EXE ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±'
    
    doLast {
        println "âœ… ëª¨ë“  ë°°í¬ íŒ¨í‚¤ì§€ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤."
        println "ğŸ“ ìœ„ì¹˜: $buildDir/distributions/"
    }
}

// JPackageë¥¼ ì‚¬ìš©í•œ ë„¤ì´í‹°ë¸Œ ì‹¤í–‰íŒŒì¼ ìƒì„± (Java 14+)
task createNativeExecutable {
    dependsOn fatJar
    group = 'distribution'
    description = 'JPackageë¡œ ë„¤ì´í‹°ë¸Œ ì‹¤í–‰íŒŒì¼ ìƒì„± (Java 14+ í•„ìš”)'
    
    doLast {
        def javaVersion = System.getProperty("java.version")
        def majorVersion = javaVersion.split('\\.')[0] as Integer
        
        if (majorVersion >= 14) {
            def packageDir = new File(project.buildDir, "native-package")
            packageDir.mkdirs()
            
            try {
                exec {
                    commandLine 'jpackage',
                        '--input', "${project.buildDir}/libs",
                        '--name', 'ChainSaw-Tetris',
                        '--main-jar', "${project.name}-fat.jar",
                        '--main-class', 'se.tetris.team5.App',
                        '--type', 'exe',
                        '--dest', packageDir.absolutePath,
                        '--win-shortcut',
                        '--win-menu',
                        '--app-version', '1.0',
                        '--description', 'ChainSaw Tetris Game - Team 5',
                        '--vendor', 'Team 5'
                }
                
                println "âœ… ë„¤ì´í‹°ë¸Œ EXE íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
                println "ğŸ“‚ ìœ„ì¹˜: ${packageDir}/ChainSaw-Tetris.exe"
                
            } catch (Exception e) {
                println "âŒ JPackage ì‹¤í–‰ ì‹¤íŒ¨: ${e.message}"
                println "ğŸ’¡ Java 14+ ë²„ì „ì´ í•„ìš”í•˜ê±°ë‚˜ JPackageê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            }
        } else {
            println "âŒ JPackageëŠ” Java 14 ì´ìƒì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."
            println "ğŸ“‹ í˜„ì¬ Java ë²„ì „: $javaVersion"
            println "ğŸ’¡ Launch4jë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ Javaë¥¼ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”."
        }
    }
}
