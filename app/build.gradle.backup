/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/9.0.0/userguide/building_java_projects.html in the Gradle documentation.
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
    // Apply the application plugin to add support for building a CLI application in Java.
    id 'application'
    id 'jacoco'
    id 'distribution'
}

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

dependencies {
    // This dependency is used by the application.
    implementation libs.guava

    // Annotation processor configuration to resolve build issues
    annotationProcessor libs.guava
}

testing {
    suites {
        // Configure the built-in test suite
        test {
            // Use JUnit4 test framework
            useJUnit('4.13.2')
        }
    }
}

// Apply a specific Java toolchain to ease working on different environments.
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

application {
    // Define the main class for the application.
    mainClass = 'se.tetris.team5.App'
}

/* âœ… íŒ€ ì „ì²´ UTF-8 ì¸ì½”ë”© ê°•ì œ ì„¤ì • (ìš´ì˜ì²´ì œ ë¬´ê´€) */
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

tasks.withType(JavaExec) {
    jvmArgs "-Dfile.encoding=UTF-8"
}

tasks.withType(Test) {
    systemProperty "file.encoding", "UTF-8"
    finalizedBy jacocoTestReport
}

jacocoTestReport {
    dependsOn test
    reports {
        xml.required = false
        csv.required = false
        html.outputLocation = layout.buildDirectory.dir('jacocoHtml')  
    }
}

// Fat JAR ìƒì„± - ëª¨ë“  ì˜ì¡´ì„±ì„ í¬í•¨í•œ ë…ë¦½ ì‹¤í–‰ ê°€ëŠ¥í•œ JAR
task fatJar(type: Jar) {
    archiveClassifier = 'fat'
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    // ë©”ì¸ í´ë˜ìŠ¤ ì§€ì • ë° UTF-8 ì¸ì½”ë”© ì„¤ì •
    manifest {
        attributes(
            'Main-Class': 'se.tetris.team5.App',
            'Implementation-Title': 'Chainsaw Tetris Game',
            'Implementation-Version': project.version,
            'Created-By': 'Team 5'
        )
    }
    
    // í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì»´íŒŒì¼ëœ í´ë˜ìŠ¤ í¬í•¨
    from sourceSets.main.output
    
    // ëª¨ë“  ëŸ°íƒ€ì„ ì˜ì¡´ì„±ì„ JARì— í¬í•¨
    from {
        configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
}

// ë„¤ì´í‹°ë¸Œ EXE ìƒì„±
task createNativeExe {
    dependsOn fatJar
    group = 'distribution'
    description = 'ë„¤ì´í‹°ë¸Œ Windows EXE íŒŒì¼ ìƒì„± (JPackage ì‚¬ìš©)'
    
    doLast {
        // ê¸°ì¡´ ë„¤ì´í‹°ë¸Œ EXE ì‚­ì œ
        def nativeDir = new File(project.buildDir, "native-exe/ChainSaw-Tetris")
        if (nativeDir.exists()) {
            nativeDir.deleteDir()
        }
        
        try {
            // JPackageë¡œ ë„¤ì´í‹°ë¸Œ EXE ìƒì„±
            def jpackageCmd = [
                'jpackage',
                '--input', "${project.buildDir}/libs",
                '--name', 'ChainSaw-Tetris',
                '--main-jar', "${project.name}-fat.jar",
                '--main-class', 'se.tetris.team5.App',
                '--type', 'app-image',
                '--dest', "${project.buildDir}/native-exe",
                '--app-version', '1.0',
                '--description', 'ChainSaw Tetris Game - Team 5',
                '--vendor', 'Team 5',
                '--icon', "${project.projectDir}/src/main/resources/Tetris_icon.ico"
            ]
            
            def process = new ProcessBuilder(jpackageCmd)
                .directory(project.projectDir)
                .start()
            
            process.waitFor()
            
            if (process.exitValue() == 0) {
                println "âœ… ë„¤ì´í‹°ë¸Œ EXE íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
                println "ğŸ“‚ ìœ„ì¹˜: ${project.buildDir}/native-exe/ChainSaw-Tetris/"
                println "ğŸ® ì‹¤í–‰: ChainSaw-Tetris.exe ë”ë¸”í´ë¦­"
                println "ï¿½ ì•„ì´ì½˜: Tetris_icon.ico ì ìš©ë¨"
            } else {
                throw new Exception("JPackage ì‹¤í–‰ ì‹¤íŒ¨")
            }
            
        } catch (Exception e) {
            println "âŒ ë„¤ì´í‹°ë¸Œ EXE ìƒì„± ì‹¤íŒ¨: ${e.message}"
            println "ğŸ’¡ Java 14+ ë²„ì „ê³¼ JPackageê°€ í•„ìš”í•©ë‹ˆë‹¤."
        }
    }
}

// EXE ë°°í¬ìš© ZIP íŒ¨í‚¤ì§€ ìƒì„±
task createExeZip(type: Zip) {
    dependsOn createNativeExe
    group = 'distribution'
    description = 'ë„¤ì´í‹°ë¸Œ EXE ë°°í¬ìš© ZIP íŒŒì¼ ìƒì„±'
    
    archiveFileName = 'ChainSaw-Tetris-Native-v1.0.zip'
    destinationDirectory = file("$buildDir/distributions")
    
    from "$buildDir/native-exe/ChainSaw-Tetris"
    
    doLast {
        println "âœ… ë„¤ì´í‹°ë¸Œ EXE ë°°í¬ìš© ZIPì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:"
        println "ğŸ“¦ íŒŒì¼: $buildDir/distributions/$archiveFileName"
    }
}

// ìµœì¢… ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±
task packageForDistribution {
    dependsOn createExeZip
    group = 'distribution'
    description = 'ë„¤ì´í‹°ë¸Œ EXE ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„±'
    
    doLast {
    dependsOn fatJar
    group = 'distribution'
    description = 'ì§„ì§œ .exe íŒŒì¼ ìƒì„± (Launch4j í•„ìš”)'
    
    doLast {
        def exeDir = new File(project.buildDir, "exe-package")
        exeDir.mkdirs()
        
        // Launch4j XML ì„¤ì • íŒŒì¼ ìƒì„±
        def launch4jConfig = """<?xml version="1.0" encoding="UTF-8"?>
<launch4jConfig>
  <dontWrapJar>false</dontWrapJar>
  <headerType>gui</headerType>
  <jar>${project.buildDir}/libs/${project.name}-fat.jar</jar>
  <outfile>${exeDir}/ChainSaw-Tetris.exe</outfile>
  <errTitle>ChainSaw Tetris - Error</errTitle>
  <cmdLine></cmdLine>
  <chdir>.</chdir>
  <priority>normal</priority>
  <downloadUrl>https://adoptium.net/</downloadUrl>
  <supportUrl>https://github.com/Team5</supportUrl>
  <stayAlive>false</stayAlive>
  <restartOnCrash>false</restartOnCrash>
  <manifest></manifest>
  <icon>${project.projectDir}/src/main/resources/Tetris_icon.ico</icon>
  <jre>
    <path></path>
    <bundledJre64Bit>false</bundledJre64Bit>
    <bundledJreAsFallback>false</bundledJreAsFallback>
    <minVersion>1.8.0</minVersion>
    <maxVersion></maxVersion>
    <jdkPreference>preferJre</jdkPreference>
    <runtimeBits>64/32</runtimeBits>
  </jre>
  <versionInfo>
    <fileVersion>1.0.0.0</fileVersion>
    <txtFileVersion>1.0.0</txtFileVersion>
    <fileDescription>ChainSaw Tetris Game - Team 5</fileDescription>
    <copyright>Team 5</copyright>
    <productVersion>1.0.0.0</productVersion>
    <txtProductVersion>1.0.0</txtProductVersion>
    <productName>ChainSaw Tetris</productName>
    <companyName>Team 5</companyName>
    <internalName>ChainSaw-Tetris</internalName>
    <originalFilename>ChainSaw-Tetris.exe</originalFilename>
  </versionInfo>
</launch4jConfig>"""
        
        def configFile = new File(project.buildDir, "launch4j-config.xml")
        configFile.text = launch4jConfig
        
        println "âš ï¸  EXE íŒŒì¼ ìƒì„±ì„ ìœ„í•´ì„œëŠ” Launch4jê°€ í•„ìš”í•©ë‹ˆë‹¤."
        println "ğŸ“¥ ë‹¤ìš´ë¡œë“œ: http://launch4j.sourceforge.net/"
        println "ğŸ“„ ì„¤ì • íŒŒì¼ ìƒì„±ë¨: $configFile"
        println "ğŸ”§ Launch4jë¡œ ì´ ì„¤ì • íŒŒì¼ì„ ì—´ì–´ì„œ EXEë¥¼ ìƒì„±í•˜ì„¸ìš”."
        println ""
        println "ğŸ“‹ Launch4j ì‚¬ìš© ë°©ë²•:"
        println "1. Launch4j ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜"
        println "2. Launch4j ì‹¤í–‰"
        println "3. ìƒì„±ëœ launch4j-config.xml íŒŒì¼ ì—´ê¸°"
        println "4. Build wrapper ë²„íŠ¼ í´ë¦­"
        println "5. ChainSaw-Tetris.exe íŒŒì¼ ìƒì„± ì™„ë£Œ!"
    }
}

// JPackageë¥¼ ì‚¬ìš©í•œ ë„¤ì´í‹°ë¸Œ ì‹¤í–‰íŒŒì¼ ìƒì„± (Java 14+)
task createNativeExecutable {
    dependsOn fatJar
    group = 'distribution'
    description = 'JPackageë¡œ ë„¤ì´í‹°ë¸Œ ì‹¤í–‰íŒŒì¼ ìƒì„± (Java 14+ í•„ìš”)'
    
    doLast {
        def javaVersion = System.getProperty("java.version")
        def majorVersion = javaVersion.split('\\.')[0] as Integer
        
        if (majorVersion >= 14) {
            def packageDir = new File(project.buildDir, "native-package")
            packageDir.mkdirs()
            
            try {
                exec {
                    commandLine 'jpackage',
                        '--input', "${project.buildDir}/libs",
                        '--name', 'ChainSaw-Tetris',
                        '--main-jar', "${project.name}-fat.jar",
                        '--main-class', 'se.tetris.team5.App',
                        '--type', 'exe',
                        '--dest', packageDir.absolutePath,
                        '--win-shortcut',
                        '--win-menu',
                        '--app-version', '1.0',
                        '--description', 'ChainSaw Tetris Game - Team 5',
                        '--vendor', 'Team 5'
                }
                
                println "âœ… ë„¤ì´í‹°ë¸Œ EXE íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
                println "ğŸ“‚ ìœ„ì¹˜: ${packageDir}/ChainSaw-Tetris.exe"
                
            } catch (Exception e) {
                println "âŒ JPackage ì‹¤í–‰ ì‹¤íŒ¨: ${e.message}"
                println "ğŸ’¡ Java 14+ ë²„ì „ì´ í•„ìš”í•˜ê±°ë‚˜ JPackageê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            }
        } else {
            println "âŒ JPackageëŠ” Java 14 ì´ìƒì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤."
            println "ğŸ“‹ í˜„ì¬ Java ë²„ì „: $javaVersion"
            println "ğŸ’¡ Launch4jë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ Javaë¥¼ ì—…ê·¸ë ˆì´ë“œí•˜ì„¸ìš”."
        }
    }
}

// ëª¨ë“  ë°°í¬ íŒ¨í‚¤ì§€ë¥¼ í•œ ë²ˆì— ìƒì„±í•˜ëŠ” í†µí•© ì‘ì—…
task packageForDistribution {
    dependsOn createDistributionZip, createWindowsExe
    group = 'distribution'
    description = 'ê²Œì„ ë°°í¬ë¥¼ ìœ„í•œ ëª¨ë“  íŒ¨í‚¤ì§€ ìƒì„±'
    
    doLast {
        println ""
        println "ğŸš€ ChainSaw Tetris ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± ì™„ë£Œ!"
        println "=" * 50
        println "ğŸ“ Windows íŒ¨í‚¤ì§€: $buildDir/windows-package/"
        println "ğŸ“¦ ë°°í¬ìš© ZIP: $buildDir/distributions/ChainSaw-Tetris-v1.0-Windows.zip"
        println "âš™ï¸  EXE ì„¤ì • íŒŒì¼: $buildDir/launch4j-config.xml"
        println ""
        println "ğŸ® ì‚¬ìš©ì ì‹¤í–‰ ë°©ë²•:"
        println "1. ZIP íŒŒì¼ì„ ì••ì¶• í•´ì œ"
        println "2. ChainSaw-Tetris.bat ë”ë¸”í´ë¦­"
        println ""
        println "ğŸ”§ EXE íŒŒì¼ ìƒì„±:"
        println "1. Launch4j ì„¤ì¹˜ í›„ ì„¤ì •íŒŒì¼ë¡œ EXE ìƒì„±"
        println "2. ë˜ëŠ” Java 14+ì—ì„œ './gradlew createNativeExecutable' ì‹¤í–‰"
        println ""
    }
}
